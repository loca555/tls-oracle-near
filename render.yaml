services:
  # Prover Service (MPC-TLS + embedded Notary + ZK proof)
  # Один сервис вместо двух: Notary встроен в Prover через tokio::io::duplex
  - type: web
    name: tls-oracle-prover
    runtime: docker
    dockerfilePath: ./prover/Dockerfile
    dockerContext: ./prover
    plan: starter  # MPC-TLS требует ~512MB+ RAM
    envVars:
      - key: PROVER_PORT
        value: "10000"
      - key: PROVER_BIND
        value: "0.0.0.0"
      - key: NOTARY_KEY_PATH
        value: /data/notary_key.bin
      - key: ZK_DIR
        value: /app/zk
      - key: ALLOWED_ORIGIN
        fromService:
          type: web
          name: tls-oracle-backend
          property: host
    disk:
      name: prover-data
      mountPath: /data
      sizeGB: 1

  # Backend + Frontend — Node.js
  - type: web
    name: tls-oracle-backend
    runtime: node
    plan: free
    buildCommand: npm install && cd frontend && npm install && npx vite build
    startCommand: node backend/server.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "10000"
      - key: NEAR_NETWORK
        value: testnet
      - key: TLS_ORACLE_CONTRACT
        value: tls-oracle-v2.nearcast-oracle.testnet
      - key: PROVER_URL
        fromService:
          type: web
          name: tls-oracle-prover
          property: host
