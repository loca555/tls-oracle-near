services:
  # Notary Server — Rust, Ed25519 signing
  - type: web
    name: tls-notary-server
    runtime: docker
    dockerfilePath: ./notary/Dockerfile
    dockerContext: ./notary
    plan: free
    envVars:
      - key: NOTARY_PORT
        value: "10000"
      - key: NOTARY_BIND
        value: "0.0.0.0"
      - key: NOTARY_KEY_PATH
        value: /data/notary_key.bin
      - key: ALLOWED_ORIGIN
        fromService:
          type: web
          name: tls-prover-service
          property: host
    disk:
      name: notary-data
      mountPath: /data
      sizeGB: 1

  # Prover Service — Rust, HTTP API
  - type: web
    name: tls-prover-service
    runtime: docker
    dockerfilePath: ./prover/Dockerfile
    dockerContext: ./prover
    plan: free
    envVars:
      - key: PROVER_PORT
        value: "10000"
      - key: PROVER_BIND
        value: "0.0.0.0"
      - key: NOTARY_URL
        fromService:
          type: web
          name: tls-notary-server
          property: host
      - key: ALLOWED_ORIGIN
        fromService:
          type: web
          name: tls-oracle-backend
          property: host

  # Backend + Frontend — Node.js
  - type: web
    name: tls-oracle-backend
    runtime: node
    plan: free
    buildCommand: npm install && cd frontend && npm install && npx vite build
    startCommand: node backend/server.js
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: "10000"
      - key: NEAR_NETWORK
        value: testnet
      - key: TLS_ORACLE_CONTRACT
        value: tls-oracle.nearcast-oracle.testnet
      - key: PROVER_URL
        fromService:
          type: web
          name: tls-prover-service
          property: host
